name: ci-cd
on:
  push:
    branches:
      - feature/workflows

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      images_exist: ${{ steps.stage_docker_images.outputs.images_exist }}
      iac_exists: ${{ steps.stage_iac_artifact.outputs.iac_exists }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Initialize environment
        uses: ./.github/actions/build/initialize-environment
      - name: Install tools
        uses: ./.github/actions/build/install-tools
      - name: Run prebuild scripts
        uses: ./.github/actions/build/script-runner
        with:
          script: prebuild
      - name: Run build scripts
        uses: ./.github/actions/build/script-runner
        with:
          script: build
      - name: Run postbuild scripts
        uses: ./.github/actions/build/script-runner
        with:
          script: postbuild
      - name: Run stage scripts
        uses: ./.github/actions/build/script-runner
        with:
          script: stage
      - name: Stage docker images
        uses: ./.github/actions/build/stage-docker-images
        id: stage_docker_images
      - name: Upload docker-images artifact
        if: steps.stage_docker_images.outputs.images_exist == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: docker-images
          path: docker-images/
      - name: Terraform plan
        id: terraform_plan
        uses: ./.github/actions/build/terraform-plan
      - name: Stage iac artifact
        if: steps.terraform_plan.outputs.iac_exists == 'true'
        uses: ./.github/actions/build/stage-iac-artifact
      - name: Upload iac artifact
        if: steps.terraform_plan.outputs.iac_exists == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: iac
          path: iac/

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment: integration
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Download docker-images artifact
        if: needs.build.outputs.images_exist == 'true'
        uses: actions/download-artifact@v4
        with:
          name: docker-images
          path: /docker-images
      - name: Download iac artifact
        if: needs.build.outputs.iac_exists == 'true'
        uses: actions/download-artifact@v4
        with:
          name: iac
          path: /iac
          merge-multiple: true
      - name: Initialize environment
        uses: ./.github/actions/deploy/initialize-environment
      - name: Install tools
        uses: ./.github/actions/deploy/install-tools
      - name: Push docker images
        uses: ./.github/actions/deploy/push-docker-images
      - name: Terraform apply
        uses: ./.github/actions/deploy/terraform-apply
